name: Memory Leak Check from Latest Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  memory_leak:
    runs-on: windows-latest

    steps:
      # Step 1: Checkout repository (needed for committing reports)
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Get latest release asset download URL
      - name: Get latest release
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const latestRelease = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const asset = latestRelease.data.assets.find(a => a.name.endsWith('.exe'));
            return asset.browser_download_url;
          result-encoding: string
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Download latest release binary
      - name: Download NotepadLite.exe
        run: |
          Invoke-WebRequest -Uri "${{ steps.get_release.outputs.result }}" -OutFile "NotepadLite.exe"

      # Step 4: Create report folder with today's date
      - name: Create report folder
        id: report
        run: |
          $today = Get-Date -Format "yyyy-MM-dd"
          $env:REPORT_DIR = "reports_$today"
          New-Item -ItemType Directory -Path $env:REPORT_DIR
          Write-Output "REPORT_DIR=$env:REPORT_DIR" >> $env:GITHUB_ENV

      # Step 5: Download Dr. Memory (memory leak detector)
      - name: Download Dr. Memory
        run: |
          Invoke-WebRequest -Uri https://github.com/DynamoRIO/drmemory/releases/download/v2.4.0/drmemory-windows-2.4.0-1.zip -OutFile drmemory.zip
          Expand-Archive drmemory.zip -DestinationPath drmemory

      # Step 6: Run NotepadLite.exe with Dr. Memory
      - name: Run memory check
        run: |
          ./drmemory/drmemory/bin/drmemory.exe -batch -report_dir ${env:REPORT_DIR} NotepadLite.exe

      # Step 7: Commit reports to 'bugs' branch
      - name: Commit reports to bugs branch
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B bugs
          git add ${env:REPORT_DIR}
          git commit -m "Memory leak report for $env:REPORT_DIR"
          git push -u origin bugs --force

      # Step 8: Upload reports as artifact
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: Memory-Leak-Reports
          path: ${env:REPORT_DIR}
