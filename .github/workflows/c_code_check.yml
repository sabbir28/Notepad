name: Memory Leak Check for NotepadLite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  memory_leak:
    runs-on: windows-latest

    env:
      REPORT_DIR: ""
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Download latest release executable (or your own built exe)
      - name: Download NotepadLite.exe
        shell: powershell
        run: |
          $exeUrl = "https://github.com/sabbir28/Notepad/releases/latest/download/NotepadLite.exe"
          $exePath = "$env:GITHUB_WORKSPACE\NotepadLite.exe"
          Invoke-WebRequest -Uri $exeUrl -OutFile $exePath -UseBasicParsing
          Write-Host "Downloaded NotepadLite to $exePath"

      # Download Dr. Memory zip
      - name: Download Dr. Memory
        shell: powershell
        run: |
          $drUrl = "https://github.com/DynamoRIO/drmemory/releases/download/release_2.6.0/DrMemory-Windows-2.6.0.zip"
          $zip = "$env:GITHUB_WORKSPACE\drmemory.zip"
          Invoke-WebRequest -Uri $drUrl -OutFile $zip -UseBasicParsing
          Expand-Archive -LiteralPath $zip -DestinationPath "$env:GITHUB_WORKSPACE\drmemory"
          Write-Host "Extracted Dr. Memory"

      # Prepare report directory
      - name: Prepare report folder
        shell: powershell
        run: |
          $today = Get-Date -Format "yyyy-MM-dd"
          $env:REPORT_DIR = "reports_$today"
          New-Item -ItemType Directory -Path $env:REPORT_DIR

      # Run Dr. Memory
      - name: Run memory analysis
        shell: powershell
        run: |
          $exe = "$env:GITHUB_WORKSPACE\NotepadLite.exe"
          $drExe = "$env:GITHUB_WORKSPACE\drmemory\drmemory-windows\bin64\drmemory.exe"
          if (-Not (Test-Path $drExe)) {
            $drExe = "$env:GITHUB_WORKSPACE\drmemory\bin64\drmemory.exe"
          }
          Write-Host "Running Dr. Memory: $drExe on $exe"
          & $drExe -batch -report_dir $env:REPORT_DIR $exe

      # Upload report as artifact
      - name: Upload memory report
        uses: actions/upload-artifact@v4
        with:
          name: NotepadLite-Memory-Report
          path: ${{ env.REPORT_DIR }}
