name: Memory Leak Check for NotepadLite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  memory_leak:
    runs-on: windows-latest

    env:
      REPORT_DIR: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download NotepadLite.exe
        shell: powershell
        run: |
          $exeUrl = "https://github.com/sabbir28/Notepad/releases/latest/download/NotepadLite.exe"
          $exePath = "$env:GITHUB_WORKSPACE\NotepadLite.exe"
          Invoke-WebRequest -Uri $exeUrl -OutFile $exePath -UseBasicParsing
          Write-Host "Downloaded NotepadLite to $exePath"

      - name: Download Dr. Memory
        shell: powershell
        run: |
          $drUrl = "https://github.com/DynamoRIO/drmemory/releases/download/release_2.6.0/DrMemory-Windows-2.6.0.zip"
          $zip = "$env:GITHUB_WORKSPACE\drmemory.zip"
          Invoke-WebRequest -Uri $drUrl -OutFile $zip -UseBasicParsing
          Expand-Archive -LiteralPath $zip -DestinationPath "$env:GITHUB_WORKSPACE\drmemory"
          Write-Host "Extracted Dr. Memory"

      - name: Prepare report folder
        shell: powershell
        run: |
          $today = Get-Date -Format "yyyy-MM-dd"
          $env:REPORT_DIR = "reports_$today"
          New-Item -ItemType Directory -Path $env:REPORT_DIR

      - name: Run memory analysis
        shell: powershell
        run: |
          $exe = "$env:GITHUB_WORKSPACE\NotepadLite.exe"

          # Identify Dr. Memory folder dynamically
          $drRoot = Get-ChildItem "$env:GITHUB_WORKSPACE\drmemory" -Directory | Select-Object -First 1
          $drExe = Join-Path $drRoot.FullName "bin64\drmemory.exe"

          if (-not (Test-Path $drExe)) {
            Write-Host "Dr. Memory executable not found at: $drExe"
            Write-Error "DrMemory.exe missing. Check extraction folder."
            exit 1
          }

          Write-Host "Running Dr. Memory: $drExe on $exe"
          & $drExe -batch -report_dir $env:REPORT_DIR $exe

      - name: Upload memory report
        uses: actions/upload-artifact@v4
        with:
          name: NotepadLite-Memory-Report
          path: ${{ env.REPORT_DIR }}
