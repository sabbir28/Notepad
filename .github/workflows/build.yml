name: Build NotepadLite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install MinGW
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64 g++-mingw-w64 binutils-mingw-w64

      - name: Build
        run: make

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NotepadLite-build
          path: build/bin/NotepadLite.exe

      - name: Fetch Latest Release Metadata
        id: latest
        run: |
          DATA=$(curl -s \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest)

          PUB_TIME=$(echo "$DATA" | jq -r '.published_at')
          if [ "$PUB_TIME" = "null" ]; then
            echo "LAST_RELEASE_EPOCH=0" >> $GITHUB_ENV
          else
            LAST_EPOCH=$(date -d "$PUB_TIME" +%s)
            echo "LAST_RELEASE_EPOCH=$LAST_EPOCH" >> $GITHUB_ENV
          fi

      - name: Gate Release (5-Hour SLA)
        id: gate
        run: |
          NOW=$(date +%s)
          DIFF=$(( NOW - LAST_RELEASE_EPOCH ))
          THRESHOLD=$(( 5 * 3600 ))

          if [ $DIFF -lt $THRESHOLD ]; then
            echo "blocked=true" >> $GITHUB_ENV
          else
            echo "blocked=false" >> $GITHUB_ENV
          fi

      - name: Set Version
        id: version
        run: |
          YY=$(date +'%y')
          MM=$(date +'%m')
          VERSION="v${YY}.${MM}.${GITHUB_RUN_NUMBER}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create Release
        if: env.blocked == 'false'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ env.VERSION }}
          name: "NotepadLite Release ${{ env.VERSION }}"
          artifacts: build/bin/NotepadLite.exe
          bodyFile: release.txt
